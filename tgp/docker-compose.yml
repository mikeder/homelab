version: "3"
services:
  api:
    container_name: tinygameplatform-api
    image: mikeder/tinygameplatform:api
    depends_on:
      - db
      - migrate
    environment:
      - PORT=8080
    restart: unless-stopped
    networks:
      - proxy
    labels:
      # enable traefik ingress
      - traefik.enable=true

      # https web
      - traefik.http.routers.tinygameplatform-https.tls=true
      - traefik.http.routers.tinygameplatform-https.entrypoints=https
      - traefik.http.routers.tinygameplatform-https.tls.certresolver=letsencrypt
      - traefik.http.routers.tinygameplatform-https.rule=Host(`api.tgp.sqweeb.net`)
      # use h2c scheme for grpc backend
      # https://doc.traefik.io/traefik/user-guides/grpc/#conclusion
      - traefik.http.services.tinygameplatform-https.loadbalancer.server.scheme=h2c

  site:
    container_name: tinygameplatform-site
    image: mikeder/tinygameplatform:site
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - proxy
    labels:
      # enable traefik ingress
      - traefik.enable=true

      # http web
      - traefik.http.routers.tinygameplatform-site-http.entrypoints=http
      - traefik.http.routers.tinygameplatform-site-http.rule=Host(`tgp.sqweeb.net`)
      - traefik.http.routers.tinygameplatform-site-http.middlewares=redirect-https # redirect http to https

      # https web
      - traefik.http.routers.tinygameplatform-site-https.tls=true
      - traefik.http.routers.tinygameplatform-site-https.entrypoints=https
      - traefik.http.routers.tinygameplatform-site-https.tls.certresolver=letsencrypt
      - traefik.http.routers.tinygameplatform-site-https.rule=Host(`tgp.sqweeb.net`)

  db:
    container_name: tinygameplatform-db
    image: postgres
    restart: always
    shm_size: 128mb
    ports:
      - "5432"
    environment:
      POSTGRES_DB: tgp
      POSTGRES_USER: tgp
      POSTGRES_PASSWORD: tgp
    networks:
      - proxy
    volumes:
      - /home/meder/homelab/tgp/data:/var/lib/postgresql/data

  migrate:
    image: mikeder/tinygameplatform:migrate
    restart: on-failure
    depends_on:
      - db
    environment:
      - DATABASEHOST=db
      - DATABASEUSERNAME=tgp
      - DATABASEPASSWORD=tgp
    networks:
      - proxy

networks:
  proxy:
    external:
      name: proxy
